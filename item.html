<!DOCTYPE html>
<html>
  <head>
    <title>Redirecting...</title>
    <meta charset="UTF-8" />
    <script>
      async function redirectBasedOnStatus() {
        const params = new URLSearchParams(window.location.search);
        const itemId = params.get("item_id");

        if (!itemId) {
          document.body.innerHTML = "Missing item_id";
          return;
        }

        const airtableToken = "pat9RntUVXY2P6OMr";
        const baseId = "apprezQKZwAZ4oaSn";
        const tableName = "Registered Items";

        const apiUrl = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}?filterByFormula={item_id}="${itemId}"`;

        try {
          const res = await fetch(apiUrl, {
            headers: {
              Authorization: `Bearer ${airtableToken}`
            }
          });

          const data = await res.json();
          const isRegistered = data.records.length > 0;

          const redirectUrl = isRegistered
            ? `https://tally.so/r/wzRyXk?item_id=${itemId}`  // FOUND
            : `https://tally.so/r/mKZ2zD?item_id=${itemId}`; // REGISTER

          window.location.href = redirectUrl;
        } catch (error) {
          document.body.innerHTML = "Error fetching from Airtable.";
          console.error(error);
        }
      }

      redirectBasedOnStatus();
    </script>
  </head>
  <body>
    Redirecting, please wait...
  </body>
</html>
